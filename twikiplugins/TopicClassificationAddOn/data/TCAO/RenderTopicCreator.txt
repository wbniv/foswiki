%META:TOPICINFO{author="LynnwoodBrown" date="1173983290" format="1.1" reprev="1.49" version="1.49"}%
%META:TOPICPARENT{name="TopicFunction"}%
---+!! Function: %TOPIC%
%FORMFIELD{"Summary"}%

This !TopicFunction draws heavily on TWiki.WebTopicCreator, but adds additional form elements for classifying the topic.

%TOC{depth="2"}%

---++ Documentation
%STARTSECTION{name="documentation" type="section"}%
This TopicFunction is for creating new topics. It is mostly called indirectly from RenderCreateNewTopic.
---+++++ Parameters
   * NAME: Determines topic naming option. If set to "auto", then the topic is automatically named and no imput box is provided. 
   * TEXT: button text; defaults to BASETOPIC name
   * VALUE: initial value of the text input field (optional)
   * FORM: TWikiForm to be used when creating a topic, defaults to TopicForm
   * TEMPLATE: TopicTemplate to be used (optional)
   * TOPICSUMMARY: If defined, a Summary input box will be included and the value of this parameter will be listed as a "tip" below the input box.
   * FACETS: List of classifications or TopicTypes for which to provide select elements. 
   * TYPE: initial TopicType value 
   * EXTRA: additional =&lt;input ... />= . Note: items much be formatted as follows:
      * quotes must be escaped with <em>double</em> backslashes ("\\").
      * Each extra item must be formatted as a TWiki 2-column table row. E.g.: ==|  *Name of item:* |   <input type="text" ...etc > |==
   * SAVE: Included "checkbox" option to directly save topic (skip "edit" screen"). If set to "checked" then checkbox will be checked by default. If set to "option" then the option will be provided but will not be checked.

%ENDSECTION{name="documentation" type="section"}%
---+++++ Css
%STARTSECTION{name="css" type="section"}%
   * None
%ENDSECTION{name="documentation" type="section"}%

---++ Implementation
<verbatim>
%STARTINCLUDE%
%INCLUDE{"%SYSTEMWEB%.WebTopicCreator" section="javascriptfunctions" }%
<script type="text/javascript">
//<![CDATA[
/**
This section contains js code added for TCAO
*/
%IFDEFINEDTHEN{"%SAVE%" glue="off"}%
        // Incorporate "direct save" option - LB 11/15/06

function toggleDirectSave(theForm) {
        if (theForm.directSave.checked) { 
           theForm.action = "%SCRIPTURLPATH{save}%/%BASEWEB%/";
        } else {
           theForm.action = "%SCRIPTURLPATH{edit}%/%BASEWEB%/";
        }
}
%FIDEFINED% 

function broadcastFacet( facet, value ) {
    insertHtml(value, "insert"+facet);
}

function assignParent( form, parent ) {
    for (var i = 0; i < form.topicparent.length; i++) {
        if (form.topicparent[i].checked) {
           break;
         }
     }
    form.topicparent[i].checked = true;
    form.topicparent[i].value = parent;
}


//]]>
</script>
<form name="newtopic" id="newtopic" action="%SCRIPTURLPATH{edit}%/%BASEWEB%/" onsubmit="return canSubmit(this,true);" method="post">
<noautolink>
<input type="hidden" name="templatetopic" value="%IFDEFINED{"%TEMPLATE%" then="%ENCODE{%TEMPLATE%}%" else=""}%" />
<input type="hidden" name="formtemplate" value="%IFDEFINED{"%FORM%" then="%FORM%" else="TopicForm"}%" />
<input type="hidden" name="TopicType" value="%IFDEFINED{"%TYPE%"}%" />
<div class="tcaoCreateNewTopic">
%TABLE{ tablewidth="90%"  columnwidths="20%, 80%" dataalign="right, left"}%
|   *Topic name:* |  
~~~      %IFDEFINEDTHEN{ "%NAME%" as="auto" }%  
~~~           <input type="hidden" name="topic" value="%IFDEFINED{"%VALUE%"}%AUTOINC0000"/>
~~~           <em>Your %IFDEFINED{"%TYPE%" then=" %TYPE% "}% topic will be auto-named.</em>  
*~~         %ELSEDEFINED% 
~~~        <input type="text" class="twikiInputField" name="topic" id="topic" size="40" 
~~~            onkeyup="canSubmit(this.form,false);" 
~~~            onchange="canSubmit(this.form,false);"  
~~~            onblur="canSubmit(this.form,true);" /> 
~~~        <input type="checkbox" class="twikiCheckbox" id="nonwikiword" name="nonwikiword" 
~~~               onchange="canSubmit(this.form,false);" onmouseup="canSubmit(this.form,false);" />
~~~              <label for="nonwikiword">%MAKETEXT{"Allow non <nop>WikiWord"}%</label>  %BR% 
~~~      <span id="webTopicCreatorFeedback" class="twikiInputFieldDisabled"><!--generated name will be put here--></span>
~~~     %FIDEFINED%    |
%IFDEFINEDTHEN{"%TOPICSUMMARY%" glue="off" }%
|   *Topic Summary:* |
~~~     <input type="text" name="Summary" size="40"  />  %BR%
~~~        %ICON{help}% <em>%TOPICSUMMARY%</em>   
~~~       | %FIDEFINED%    
%IFDEFINEDTHEN{"%FACETS%" glue="off"}%
%~~       FORMATLIST{"%FACETS%" 
~~~          separator=" $n" 
~~~          format="|    *$1:* | <select name=\"$1\" id=\"$1\" onchange=\"broadcastFacet(this.id, this.value)\" > 
~~~              <option value=$percntURLPARAM{$1}$percnt > $percntURLPARAM{\"$1\" default=\"Select...\" }$percnt </option> 
~~~             $percntDBQUERY{
~~~                  \"$percntDBQUERY{\".\" topic=\"$1\" web=\"$percntBASEWEB$percnt\" format=\"$formfield(Classification)\"}$percnt='$1'\" 
~~~                  web=\"%BASEWEB%\" 
~~~                  format=\"<option>$topic</option>\" separator=\" \" }$percnt </select> </noautolink> |  "}%  %FIDEFINED%   
*~~
%~~      IFDEFINED{"%EXTRA%" 
~~~          then="$n%EXTRA%"
~~~          glue="off" 
~~~       }%
|    *%MAKETEXT{"Topic parent:"}%* |  
~~~     <input type="radio" name="topicparent" checked value="%URLPARAM{\"parent\"}%" 
~~~          onclick="this.form.topicparentList.disabled=true;" > <nop>%URLPARAM{"parent" default="no parent, orphaned topic"}%  
~~~      %BR% %IFDEFINEDTHEN{"%FACETS%" as=".*SubjectArea"}% 
~~~            <input type="radio" name="topicparent" onclick="this.value=this.form.SubjectArea.value;this.form.topicparentList.disabled=true;" value="" > 
~~~            Selected !SubjectArea: <span id="insertSubjectArea" > </span> %BR% %FIDEFINED%
~~~      <input type="radio" name="topicparent" value="" onclick="this.form.topicparentList.disabled=false"> Select topic parent: <select name="topicparentList" size="1"  diabled ~~~            onchange="assignParent(this.form, this.value);" ><option value="" > Select... </option><option value="">%MAKETEXT{"(no parent, orphaned topic)"}%</option>
~~~            %TOPICLIST{"<option>$name</option>" separator=" " }% </select>
~~~      <br />%ICON{help}% _Topic "parentage" defines the hierarchy in [[%BASEWEB%.TopicTree][TopicTree]]._   |
|| <input id="submit" type="submit" class="twikiSubmit" value='%MAKETEXT{"Create this topic"}%' />
~~~        
%~~        IFDEFINED{"%SAVE%" then="<input type=\"checkbox\" $variable name=\"directSave\" value=\"save\"> 
~~~            _Directly save topic without editing._ " glue="off" 
~~~        }%
~~~        <input type="hidden" name="onlywikiname" />
~~~        <input type="hidden" name="onlynewtopic" value="on" />   ||

</div> <!-- tcaoCreateNewTopic -->
</form>
%IFDEFINEDTHEN{"%NAME%" as="auto" glue="off"}%
%ELSEDEFINED%
<script type="text/javascript">
//<![CDATA[
// start with a check
canSubmit(document.forms.newtopic,false);
// focus input field
document.forms.newtopic.topic.focus();
%IFDEFINED{"%SAVE%" then="toggleDirectSave(document.forms.newtopic);" glue="off"}%
//]]>
</script>
%FIDEFINED%
</noautolink>
%STOPINCLUDE%
</verbatim>

---++ Test

%DBCALL{"%TOPIC%" TEXT="Topic" TYPE="DiscussionTopic" VALUE="TWikiTopic" FACETS="TopicType, SubjectArea" SAVE="option" PARENT="topic" TOPICSUMMARY="Enter short summary statement about your new topic" }%


%DBCALL{"RenderFunctionCallers"}%

---++ Copyright
<div style="text-align:justify;margin:1em;">
(C) 2006 LynnwoodBrown@Skyloom.com

%DBCALL{"GnuGeneralPublicLicense" section="notice"}%
</div>



%META:FORM{name="TopicForm"}%
%META:FIELD{name="TopicType" attributes="" title="TopicType" value="TopicFunction"}%
%META:FIELD{name="SubjectArea" attributes="" title="SubjectArea" value="TcaoUse"}%
%META:FIELD{name="Summary" attributes="" title="Summary" value="TopicFunction to display a form to create a new classified topic"}%
